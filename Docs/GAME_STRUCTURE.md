# 게임 구조

이 문서는 DiceyKingdom의 게임 구조/시스템/런타임 흐름을 정리합니다. 레포 지도는 `Docs/PROJECT_MAP.md`, 범용 규칙은 `Docs/GENERAL_RULES.md`를 참고합니다.

## 문서 범위/분리 기준

- 범용 규칙/컨벤션: `Docs/GENERAL_RULES.md`
- 레포 지도(파일 위치/책임 요약): `Docs/PROJECT_MAP.md`
- 아이디어 원문/백로그: `Docs/GAME_IDEA_BACKLOG.md`
- 이 문서: 실제 구현 기준이 되는 게임 구조, 시스템, 데이터/씬 흐름

## 프로덕트 요약 (한 줄)

- 2D 판타지 왕국의 왕이 되어, 매 턴 주사위를 분배해 위기를 관리하는 턴제 로그라이크 경영 게임.

## 현재 개발 단계(중요)

- 기준일: 2026-02-09
- 현재 최우선 목표는 "완성 기획 고정"이 아니라 "핵심 컨셉 검증용 플레이어블 프로토타입" 제작입니다.
- 핵심 검증 가설:
  - 결과가 불확실한 자원을 분배하는 행위 자체가 반복 플레이에서 재미를 제공하는가
- 1차 검증 기준(확정):
  - 플레이 중/종료 후 "재미 신호"가 명확하게 감지되는가
  - 약 `10`회 플레이에서도 재미 신호가 거의 없으면 아이디어를 중단 후보로 판정
- 프로토타입 가드레일(확정):
  - 분배 단위를 모험가로 실험할 경우, 단위 수는 `4`로 고정
  - 스킬 최소 세트 3종을 기본 보유로 시작
    - 원하는 모험가 리롤
    - 원하는 주사위 눈 +1
    - 지정 몬스터에 피해 2
  - 모든 스킬은 개별 쿨다운을 가지며, 각 스킬은 턴당 `1`회만 사용 가능
  - 검증 초점은 "모험가 <-> 스킬 시너지의 재미 체감"으로 둠
- 실험 전략(확정):
  - `선택지 A` 적용: 분배 단위만 모험가로 전환하고, 진행 구조는 기존 연속 누적 턴 보드를 유지
  - 이번 사이클에서는 단일 빌드로 플레이테스트 수행
  - 스테이지 단위 + 준비시간 액션 구조는 차기 사이클 후보로 보류
  - 해석 리스크를 줄이기 위해, 세션마다 "재미 신호 약화 원인"을 태그 로그로 기록
- 문서 내 기존 세부 규칙/수치/용어는 참고 베이스라인이며, 프로토타입 결과에 따라 구조적 변경(예: 분배 단위/보드 구조) 가능성이 열려 있습니다.
- 충돌 시 우선순위:
  - 프로토타입 검증 목표 > 기존 상세 규칙

### 프로토타입 구현 범위(v0 확정)

- 포함:
  - 분배 단위를 모험가로 전환
  - 모험가 수 `4` 고정
  - 스킬 3종 기본 보유(리롤, 눈 +1, 몬스터 피해 2)
  - 스킬 규칙: 개별 쿨다운 + 각 턴당 스킬별 1회 사용
  - 기존 연속 누적 턴 보드 구조 유지
  - 런 종료 조건 `Stability <= 0`
  - 런 종료 시 재미 신호(있음/없음) + 원인 태그 기록
- 제외:
  - 스테이지 단위 + 준비시간 액션 구조
  - 모험가 수 증가(4->5->6)
  - 확장 성장 시스템/경제 확장/메타 진행

### 프로토타입 구현 순서(v0)

1. 모험가 최소 데이터 스키마 정의(굴림 주사위 수, 고유 효과, 장비 슬롯)
2. 기존 주사위 분배 UI/로직을 모험가 분배로 치환
3. 스킬 3종 효과 구현(리롤, 눈 +1, 몬스터 피해 2)
4. 스킬 사용 UI/피드백 구현(선택 대상 표시, 사용 결과 로그)
5. 연속 턴 보드에서 성공/실패 정산이 모험가 체계와 맞물리도록 연결
6. 런 종료 설문(재미 신호 + 원인 태그) 수집 기능 추가
7. 최소 `10`회 플레이테스트 수행 후 로그 기반으로 규칙 조정

## 게임 컨셉

- 플레이어는 왕국의 군주로서 매 턴 주사위를 굴리고, 보드에 쌓이는 상황 카드를 해결해 왕국을 생존시킵니다.
- 핵심 생존 자원은 `안정도`이며, 안정도가 0 이하가 되면 즉시 게임 오버입니다.
- `V1` 진행 목표는 엔딩형이 아닌 생존형(얼마나 오래 버티는지)으로 고정합니다.

## 런 목표(V1 확정)

- `V1` 런 목표는 생존형 1종만 사용합니다.
- 런 종료 조건은 `Stability <= 0`입니다.
- 보스/엔딩/특수 승리 조건은 `V2` 이후 확장 항목으로 분리합니다.

## 용어 사전(확정)

- `Situation` / `상황`
  - 보드에 생성되는 문제/기회 단위
- `Skill` / `스킬`
  - 액티브 능력 카테고리(인물 테마)
- `Structure` / `구조물`
  - 영구 패시브 카테고리(건물/시설 테마)
- `Decree` / `칙령`
  - 즉시 사용 소모성 수단
- `Stability` / `안정도`
  - 왕국 생존 자원(0 이하 시 게임 오버)
- `Gold` / `골드`
  - 런 내 공용 경제 통화
- `Demands` / `요구치`
  - 상황 슬롯 해결에 필요한 수치
- `Tags` / `태그`
  - 상황/효과 분류 키워드(예: 침략, 기근)
- `Deadline` / `데드라인`
  - 상황 만료 시점 판정 용어
- `Run` / `런`
  - 게임 1회 플레이 단위
- `Turn` / `턴`
  - 런 내 최소 진행 단위
- `Phase` / `페이즈`
  - 턴 내부 고정 단계

### 용어 사용 규칙(확정)

- 문서/코드/데이터/UI에서 같은 개념은 항상 동일 용어를 사용합니다.
- 한글 표기 우선, 영문은 괄호로 병기합니다.
- 기존 표현은 점진적으로 `스킬(Skill)`, `구조물(Structure)`, `칙령(Decree)` 기준으로 통일합니다.
- 경제 용어는 `재화` 대신 `골드(Gold)`를 기본 표기로 사용합니다.

## 디자인 철학(확정)

- 목표는 플레이어를 괴롭히는 것이 아니라, 도전적인 난이도에서 시너지 탐색/실험/실현의 성취감을 제공하는 것입니다.
- 난이도와 보상은 함께 설계하며, "어려움만 있고 보상이 없는 상태"를 피합니다.
- 소모품을 한 턴에 집중 사용해 폭발적인 결과를 만드는 플레이는 허용하되, 그 전제는 충분한 희소성과 기회비용입니다.
- 강력한 시너지는 만들기 어렵게 설계하고, 특정 고점 전략이 모든 상황에 통하지 않도록 카운터 기믹을 함께 배치합니다.
- 선택은 흥미로워야 하며, 과도한 복잡도로 인해 피로를 유발하는 설계는 지양합니다.
- 모든 효과는 "한 번 읽고 이해 가능한 단문 규칙"을 우선하며, 길고 조건이 많은 효과는 예외적으로만 허용합니다.

## 씬/런타임 흐름

- `Bootstrap` -> `MainMenu` -> `RunScene` 진입
- `RunScene`에서 단일 런이 진행되며, 턴 단위로 상황 생성/해결/정산을 반복
- 런 종료 조건: 안정도 0 이하

## 핵심 루프

1. 턴 시작
2. 상황 보드 갱신(신규 상황 추가, 지속 효과 갱신)
3. 주사위 배치(상황 단위 할당)
4. 주사위 굴림
5. 스킬/칙령 보정 후 슬롯 해소(상황 성공 시 보상 즉시 지급)
6. 턴 종료 정산(미해결 카드 남은 턴수 감소, `Deadline` 실패 처리, 안정도 증감)
7. 다음 턴 반복

## 데이터 로딩

- 템플릿은 `SaCache` + `StaticDataManager` 기반의 JSON 로딩 흐름을 제공합니다.
- 프로젝트 초안 데이터 테이블:
  - `Situations.json`: Situation 정의
  - `DiceBuffs.json`: 주사위 강화 정의
  - `Skills.json`: Skill 정의
  - `Legacies.json`: Structure 정의
  - `Consumables.json`: Decree 정의

## 저장/로드

- 템플릿은 `SaveService` 기반의 일반 저장/로드 유틸을 제공합니다.
- 런타임 저장 스키마 초안:
  - 현재 턴 수
  - 현재 안정도/최대 안정도
  - 보유 주사위/강화 상태
  - 보유 스킬/쿨다운 상태
  - 보유 구조물
  - 보드 위 상황 카드 상태(남은 턴수/남은 슬롯 수치/적용된 상태이상)
  - 경제 값(골드)

## UI/UX 공용 시스템

- 모달/토스트/툴팁/플로팅 텍스트는 공용 UI 유틸로 제공됩니다.
- 런 보드 UI 요구사항 초안:
  - 상황 카드별 태그, 남은 턴수, 슬롯 목표치, 보상/실패 효과 표시
  - 주사위 배치 가능/불가 상태 가시화
  - 스킬 쿨다운 및 사용 가능 조건 표시
  - `P4` 종료 시 미소비 주사위 경고 모달 표시
  - 안정도 변화 로그 표시

## 오디오

- `AudioManager`(SFX), `BgmManager`(BGM) 공용 유틸 제공.

## 난수

- 주사위 굴림은 `System.Random` 기반으로 처리합니다.
- 재현성(디버깅/시드 런)이 필요하므로 런 시작 시 시드를 저장합니다.

## 텍스트 스타일(프로젝트별)

- 기준: `Assets/GlobalTextStyles.asset`
- TODO: 프로젝트 스타일 이름 확정 후 반영

## 핵심 시스템 규칙(초안)

### 안정도
- 왕국의 체력 역할을 수행합니다.
- 상황 실패, 디버프, 이벤트 등에 의해 감소합니다.
- 보상, 유산, 고정 행동(예: 영지 순찰) 등으로 회복할 수 있습니다.

### 주사위
- 매 턴 플레이어는 보유한 주사위를 굴립니다.
- 기본 주사위 눈 범위는 1~6입니다.
- 각 주사위는 강화 1개를 장착할 수 있습니다.
- 강화 예시:
  - 모든 눈 +1
  - 최소 1회 리롤 보장
  - 2회 굴림 후 높은 눈 채택

### 상황(Situation)
- 상황은 `태그`, `남은 턴수`, `슬롯 요구치(Demands)`, `실패 효과`, `성공 보상`을 가집니다.
- 하나의 상황은 여러 슬롯을 가질 수 있으며, 모든 슬롯을 해결해야 성공합니다.
- 상황별로 턴당 배치 가능한 최대 주사위 수가 존재할 수 있습니다.
- `영지 순찰`처럼 상시 재생성되는 무기한 상황도 존재할 수 있습니다.

### 스킬(Skill)
- 액티브 능력으로 턴 쿨다운을 가집니다.
- 주사위 재굴림, 눈 보정, 상황 턴 연장 등 전술적 보정을 담당합니다.
- 일부 스킬은 상황당 사용 횟수 제한을 가집니다.
- 쿨다운이 0이 되면 해당 턴에 즉시 사용 가능합니다.

### 구조물(Structure)
- 런 동안 유지되는 영구 패시브입니다.
- 빌드 방향성과 장기 성능을 결정하는 핵심 성장 축입니다.
- 테마는 건물/시설/설치물 방향으로 고정합니다.

### 칙령(Decree)
- 특정 태그/상황에 강한 즉시 사용형 카드입니다.
- 연출 테마는 칙령/문서류(소모성 정책 발동) 방향을 기본안으로 둡니다.
- 포지션은 "위기 대응용 윤활유"이며, 희소 공급 + 구매 기회비용을 통해 상시 정답 전략화를 방지합니다.

## 턴 처리 규칙(부분 확정)

1. 턴 시작: 신규 상황 카드가 규칙에 따라 보드에 추가됩니다.
2. 배치 단계: 플레이어가 주사위를 `Situation` 단위로 할당합니다.
3. 굴림 단계: 할당 주사위를 굴려 결과를 생성합니다.
4. 보정/해결 단계:
   - 스킬/칙령으로 결과를 보정합니다.
   - 굴린 주사위를 슬롯에 소모해 `Demands`를 감소시킵니다.
   - 모든 슬롯이 해결된 상황은 즉시 성공 처리되며, 보상도 즉시 지급됩니다.
5. 종료 정산(미해결 상황만 대상):
   - 미해결 카드의 남은 턴수를 감소시킵니다.
   - 남은 턴수가 0이 된 미해결 상황은 실패 처리합니다.
   - 실패 처리 완료 카드는 보드에서 제거합니다.
6. 안정도 0 이하 여부를 판정합니다.

### 턴 최소 사이클 단위(상태머신 부분 확정)

- 용어 정의
  - `Phase`: 턴을 구성하는 고정 단계
  - `Window`: 플레이어가 스킬/칙령 등 능동 효과를 사용할 수 있는 구간
  - `Commit`: 해당 단계 결과가 확정되어 되돌릴 수 없는 지점
- 사이클 정의
  - `P0 TurnStart`
    - 주사위 리필, 스킬 쿨다운 감소, 턴 시작 트리거 처리
    - `Commit`: 리필/쿨다운 결과 확정
  - `P1 BoardUpdate`
    - 신규 상황 생성, 보드 상태 갱신(턴 시작형 지속효과 포함)
    - `Commit`: 이번 턴 보드 구성 확정
  - `P2 Assignment`
    - 플레이어가 주사위를 `Situation` 단위로 배치(슬롯 미확정)
    - `Window`: 스킬/칙령 사용 가능
    - `Commit`: 주사위-상황 귀속 확정
  - `P3 Roll`
    - 배치된 주사위를 굴려 결과 생성
    - `Commit`: 원시 굴림값 확정
  - `P4 Adjustment`
    - 굴림값/상황 상태를 보정하는 효과 처리
    - `Window`: 스킬/칙령 사용 가능
    - 주사위를 슬롯에 소모해 `Demands`를 감소
    - 모든 슬롯 해결 시 해당 상황 즉시 `성공` + 보상 즉시 지급
    - `Commit`: 최종 적용값 및 P4 내 즉시 보상 결과 확정
  - `P5 Settlement`
    - 내부 순서:
      1. `미해결` 카드 남은 턴수 1 감소
      2. 턴수 0 이하 + 미해결 카드 `Deadline` 실패 판정
      3. 실패 효과를 보드 고정 순서로 순차 적용
      4. 처리 완료 카드 제거 및 로그 기록
    - `Commit`: 턴 결과 확정
  - `P6 EndTurn`
    - 턴 종료형 지속효과 처리, 게임오버 판정
    - 다음 턴으로 이행

### 턴 시작 리필 규칙(확정)

- 플레이어 보유 주사위는 턴 시작 시 전부 리필됩니다.
- 플레이어 보유 스킬의 쿨다운은 턴 시작 시 감소합니다.
- 쿨다운이 0이 된 스킬은 같은 턴에 즉시 사용 가능합니다.

### 스킬/칙령 사용 규칙(확정)

- 모든 스킬은 개별 쿨다운을 가집니다.
- 각 스킬은 턴당 `1`회만 사용 가능합니다.
- 턴당 소모품 사용 횟수 제한은 없습니다.
- 효과 비용은 대부분 무료를 기본값으로 보되, 일부 스킬/칙령은 골드 비용을 가질 수 있습니다.
- 사용 윈도우는 `P2 Assignment`, `P4 Adjustment`로 제한합니다.
- `P3 Roll` 및 `P5 Settlement` 이후에는 스킬/칙령을 사용할 수 없습니다.
- 비용이 있는 효과는 항상 사용 전에 비용을 지불합니다.
- 골드가 부족하면 해당 효과는 사용할 수 없습니다.
- 사용 가능/불가 상태는 UI에서 즉시 식별 가능해야 합니다.
- 소모품은 턴당 제한이 아니라 보유량 한도로 관리합니다.
- 프로토타입 v0에서는 무쿨다운 스킬을 사용하지 않습니다.

### 주사위 배치/소비 규칙(확정)

- `P2 Assignment`에서는 주사위를 `Situation`에만 배치하고, 개별 슬롯 지정은 `P4`에서 처리합니다.
- `P2`에서 배치된 주사위는 `P4`에서 같은 `Situation` 내부 슬롯에만 사용할 수 있습니다.
- 기본 규칙으로는 `Situation` 간 주사위 이동/재배치를 허용하지 않습니다.
- 예외적으로, 명시된 스킬/칙령 효과가 있을 때만 `Situation` 간 이동/교환을 허용합니다.
- `P4`에서 상황이 해결되어 획득한 모든 것(골드/칙령/스킬 포함)은 같은 `P4`에서 즉시 사용 가능합니다.
- `P4` 종료 시점에 미소비 주사위가 있고 합법적 배치 대상이 1개 이상 남아 있으면 경고 모달을 표시하고, 플레이어 확인 후에만 종료할 수 있습니다.

### 골드 저점 규칙(확정)

- 골드는 기본적으로 음수를 허용하지 않습니다.
- 골드는 `최소값(min floor)` 개념을 가지며, 기본 저점은 0입니다.
- 특정 효과(예: 은행형 구조물)는 저점을 일시적으로 음수 구간으로 변경할 수 있습니다.
- `min floor`는 "해당 골드가 내려갈 수 있는 최저선"을 뜻합니다.
- `min floor` 변경 효과가 여러 개일 경우 변화량을 합산합니다.
  - 예: 기본 0, 효과 A(-10), 효과 B(+2) -> 최종 `min floor` = -8

### 실패 효과 처리 순서(확정)

- `P5 Settlement`의 실패 효과는 합산 처리하지 않고 순차 처리합니다.
- 적용 순서는 매 턴 UI 보드 정렬 순서(좌 -> 우, 상 -> 하)로 고정합니다.
- 같은 순서를 `Deadline` 배지/로그에도 그대로 표시해 예측 가능성을 유지합니다.

### 상태효과 시간축 규칙(부분 확정)

- 지속시간 감소 시점은 `P6 EndTurn`으로 통일합니다.
- 동일 상태효과가 중첩되면 강도(stacks) 개념은 사용하지 않고 지속시간만 합산합니다.
- UI는 각 상태효과에 대해 아래 2가지를 표시합니다.
  - 남은 턴 수
  - 이번 턴 신규 부여 여부

### 상태효과 최소 스키마(확정)

- 상태효과 데이터는 아래 필드만 사용합니다.
  - `status_id`
  - `start_turn`
  - `end_turn`
- 활성 판정식:
  - `start_turn <= current_turn < end_turn`
- 동일 `status_id` 재부여 시:
  - `end_turn`만 연장(지속시간 합산)
- 기본 부여 규칙:
  - `start_turn = current_turn`
  - `end_turn = start_turn + duration`
- 상태효과는 부여된 턴에 즉시 활성화됩니다.
- 현재 기준에서는 `applied_turn` 같은 보조 필드를 두지 않습니다.

## 턴 파워 예산 vs 위협 예산 변수 프레임(진행중)

- 턴 파워 예산 `P_turn`은 아래 합으로 관리합니다.
  - `P_dice`: 이번 턴 리필 주사위로 즉시 생성 가능한 파워
  - `P_skill_free`: 이번 턴 사용 가능한 무료 Skill 파워
  - `P_skill_paid`: 골드 비용을 지불해 전환 가능한 Skill 파워
  - `P_item`: 이번 턴 사용 가능한 Decree 파워
- 위협 예산 `T_turn`은 아래 합으로 관리합니다.
  - `T_now`: 현재 보드 슬롯 요구치
  - `T_deadline`: 남은 턴수 압박으로 인한 가중 위협
  - `T_fail`: 실패 시 즉시/지속 페널티 기대 손실
- 목표 상태:
  - 평균 상황에서는 `P_turn`으로 전부 해결이 아닌 "선택적 해결"이 발생해야 함
  - 고위험 턴에서는 비용형 Skill/Decree로 `P_skill_paid`, `P_item`을 동원해 위기 탈출 가능해야 함
  - 무쿨다운+무비용 조합으로 무한 보정 루프가 생기지 않아야 함
  - Decree 폭발 턴은 허용하되, 상시 재현 가능한 기본 전략이 되지 않도록 희소성/공급량을 관리해야 함

### 예산 평가 우선순위(확정)

- 1순위는 `평균 기대값` 기반으로 파워/위협 균형을 맞춥니다.
- 하한 안전값은 "재시작 접근성"과 "칙령(Decree) 윤활 장치"로 보완합니다.

## 예시 진행(문서화)

- 초기 상태
  - 주사위 4개(기본 3, 2회 굴림 후 높은 눈 채택 강화 1)
  - 스킬: 대상 상황 남은 턴수 +1(쿨다운 4, 상황당 1회)
  - 구조물: 이번 턴 최저 눈 +1
- 보드 상황
  - `오크 부대`(침략): 남은 턴수 1, 목표치 10, 최대 3주사위
  - `메뚜기 떼`(기근): 남은 턴수 2, 목표치 5/8
- 배치/굴림 결과
  - 오크 부대에 3주사위 배치 -> 4, 2, 3 합계 9
  - 메뚜기 떼 5 슬롯에 1주사위 배치 -> 6으로 슬롯 해결
- 판정
  - 오크 부대 목표치 1 남음 -> 실패 위험
  - 스킬 사용으로 오크 부대 남은 턴수 +1
  - 다음 턴에 잔여 목표치(오크 1, 메뚜기 8)를 이어서 해결

## 밸런스 기준(초안)

- 판단 강도: 매 턴 "모든 문제 해결"이 아니라 "무엇을 포기할지"를 결정하게 설계
- 시너지 가치: 단일 고성능 옵션보다 조합(주사위 강화 + 스킬 + 구조물)이 더 강하도록 설계
- 리스크 관리: 단기 손해를 감수해 장기 성장(구조물/강화)을 선택할 여지를 보장

### 수치 확정 게이트

- 아래 핵심 파라미터가 확정되기 전에는, 신규 아이디어는 수치보다 기믹/상호작용/트레이드오프 중심으로 기록합니다.
  - 스타팅 주사위 수 및 성장 속도
  - 턴당 평균 상황 카드 수/난이도 곡선
  - 스킬/구조물/칙령의 평균 파워 예산

## 아이디어 밸런스 체크리스트(리뷰 기준)

- 전력 곡선: 초반/중반/후반 중 특정 구간만 과도하게 강해지지 않는가
- 선택 다양성: 특정 조합이 사실상 강제되어 빌드 다양성을 해치지 않는가
- 상호작용 리스크: 리롤/배수/오버킬 등과 결합 시 무한 이득 루프가 생기지 않는가
- 실패 허용성: 실수 1회가 즉시 런 파괴로 이어져 복구 불가능해지지 않는가
- 보상 적정성: 난이도 대비 보상이 과소/과대하지 않은가

### 밸런스 판정 라벨

- `오버밸런스`: 평균적인 선택 대비 기대값이 지나치게 높고, 사실상 필수 선택이 되는 상태
- `언더밸런스`: 사용 조건/리스크 대비 기대값이 낮아 선택 동기가 부족한 상태
- `중립(조건부)`: 특정 조건에서만 강하고, 명확한 대가/제약이 있는 상태

## 미해결 설계 질문

- 모험가 단위의 최소 스키마(굴림 주사위 수/고유 효과/장비 슬롯)의 데이터 구조 확정
- 스킬 3종의 개별 쿨다운 턴수 값 확정
- 스테이지 단위 구조를 2차 실험으로 전환할 조건/시점 확정
- 상황 카드 생성 규칙(턴당 생성 수, 태그 분포, 난이도 가중치)
- 오버킬 처리 방식(남는 수치 이월 여부 + 오버킬 트리거/보상 규칙)
- 은행형 대출 한도(`N`) 값 확정

## 관련 문서

- 공통 규칙: `Docs/GENERAL_RULES.md`
- 레포 지도: `Docs/PROJECT_MAP.md`
- 아이디어 백로그: `Docs/GAME_IDEA_BACKLOG.md`
