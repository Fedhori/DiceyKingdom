# 강화(Upgrade) 시스템 PRD

## 1. 소개/개요
아이템에 1개만 적용 가능한 강화(Upgrade) 시스템을 추가한다. 강화는 상점에서 구매하고, 조건을 만족하는 아이템에 적용되며, 기존 강화는 새 강화로 교체된다. 강화는 아이템과 동일한 등급 체계를 사용하고, 상점 슬롯에서 아이템과 혼합 등장한다.

## 2. 목표
- 강화 데이터 파이프라인(JSON → DTO → Instance → Manager) 구축
- 상점에서 아이템/강화 혼합 등장(80/20) 및 등급 확률 적용(60/30/10/0)
- 강화 구매/적용 흐름 제공(유효 슬롯 하이라이트, 드래그/클릭 적용)
- 아이템에 강화가 귀속되고 교체 가능하도록 처리
- 툴팁에 강화 표시(아이템명 + 강화명)

## 3. 사용자 스토리
- 플레이어로서 상점에서 강화를 구매해 특정 아이템을 강화하고 싶다.
- 플레이어로서 이미 강화된 아이템에 다른 강화를 적용해 교체하고 싶다.
- 플레이어로서 강화 적용 여부와 강화 이름을 툴팁에서 확인하고 싶다.

## 4. 기능 요구사항
1. **강화 데이터 정의**
   - `Assets/StreamingAssets/Data/Upgrades.json`에 강화 정의를 추가한다.
   - `UpgradeDto`, `UpgradeInstance`, `UpgradeRepository`, `UpgradeManager`를 추가한다.
   - 강화는 `id`, `price`, `rarity`, `conditions`, `effects`를 가진다.
   - 강화 등급은 `ItemRarity`(Common/Uncommon/Rare/Legendary)를 재사용한다.

2. **강화 등장 확률**
   - 상점 슬롯마다 아이템 80%, 강화 20%로 롤링한다.
   - 강화는 등급 시스템이 없으며, 모든 강화는 동일하게 취급한다.
   - 강화 풀에 아이템이 없으면 아이템으로 대체한다.

3. **강화 상품 모델**
   - `ProductType`에 `Upgrade`를 추가한다.
   - `UpgradeProduct`를 추가하고 `IProduct` 흐름에 통합한다.
   - 강화 전용 UI 프리팹을 사용한다(아이템 상품 UI 재사용 금지).

4. **강화 구매/적용**
   - 강화는 인벤토리에 보관되지 않고, 구매 즉시 아이템에 적용된다.
   - 강화 선택 시, 조건을 만족하는 아이템 슬롯만 유효 대상으로 하이라이트한다.
   - 클릭 또는 드래그로 유효 슬롯에 적용할 수 있다.

5. **강화 교체**
   - 아이템에는 강화가 1개만 적용 가능하다.
   - 새 강화 적용 시 기존 강화는 제거되고 새 강화가 귀속된다.

6. **강화 효과 적용 방식**
   - 아이템의 `StatSet`에 `StatLayer.Upgrade`를 추가해 강화 전용으로 적용한다.
   - 강화 제거 시 `Upgrade` 레이어의 해당 소스를 제거한다.

7. **툴팁 표시**
   - 아이템 툴팁 제목에 `아이템명 (강화: 강화명)` 형식으로 표시한다.
   - 강화명은 `upgrade` 로컬라이징 테이블에서 가져온다.
   - 강화 상품도 마우스 호버 시 툴팁이 노출된다.
   - 강화 상품 툴팁에는 다음을 포함한다:
     - 강화 이름
     - 강화 효과
     - 기존 희귀도 표시 영역에는 “강화” 텍스트를 표기

8. **예시 강화**
   - 힘의 돌: `damageMultiplier` x2, 조건: `HasDamageMultiplier`
   - 바람의 돌: `attackSpeed` x2, 조건: `HasAttackSpeed`

## 5. 비목표(Out of Scope)
- 강화 전용 인벤토리/보관함 기능
- 강화 전용 VFX/아이콘 고급 연출
- 강화의 중첩 적용(1개만 허용)
- 강화 아이템과 일반 아이템 간 거래/재화 환불 정책 확장

## 6. 디자인 고려사항
- 강화 상품은 별도 UI 프리팹을 사용한다(기존 아이템 상품 UI 재사용 금지).
- 강화 상품도 아이콘을 표시한다.
- 유효 슬롯 하이라이트 규칙은 기존 아이템 선택 흐름과 동일하게 유지한다.
- 툴팁 제목에 강화명만 표시(임시).

## 7. 기술 고려사항
- **조건 판별(값 기준)**  
  강화 조건은 JSON 필드 존재 여부가 아니라, 값이 0 초과인지로 판단한다.
  - 예: `damageMultiplier > 0`면 `HasDamageMultiplier` 조건 통과
  - 예: `attackSpeed > 0`면 `HasAttackSpeed` 조건 통과
  - 예: `projectile != null`이면 `HasProjectile` 조건 통과
- 강화 효과 적용은 기존 `ItemEffect` 체계를 재사용한다.
- 강화 아이콘 경로 규칙은 `Sprites/Upgrade/{id}`를 사용한다.
- 선택/하이라이트 흐름은 `ShopManager` + `ItemSlotManager` 기존 로직 확장으로 대응한다.

## 8. 성공 지표
- 상점에서 강화가 20% 비율로 등장한다.
- 강화가 조건을 만족하는 아이템에만 적용된다.
- 강화 적용 후 아이템 스탯이 정상적으로 변경된다.
- 동일 아이템에 다른 강화 적용 시 기존 강화가 제거된다.
- 툴팁에 강화명이 표시된다.

## 9. 열린 질문
- 없음.
